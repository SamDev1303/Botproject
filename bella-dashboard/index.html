<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Princess Bella - Live Status</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        :root {
            --sky-blue: #87CEEB;
            --sky-dark: #5c94fc;
            --ground-brown: #8B4513;
            --grass-green: #228B22;
            --brick-red: #d85800;
            --pipe-green: #00a800;
            --coin-yellow: #FFD700;
            --princess-pink: #FFB6C1;
            --text-white: #fcfcfc;
            --dark-bg: #1a1a2e;
            --card-bg: #16213e;
            --accent: #e94560;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Press Start 2P', monospace;
            background: linear-gradient(180deg, var(--sky-blue) 0%, var(--sky-dark) 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .game-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 8px;
            padding-bottom: 80px;
        }

        /* Compact Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--dark-bg);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .header-title {
            font-size: 10px;
            color: var(--coin-yellow);
            text-shadow: 2px 2px 0 #000;
        }

        .header-stats {
            display: flex;
            gap: 16px;
            font-size: 8px;
            color: var(--text-white);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            color: var(--coin-yellow);
            font-size: 10px;
        }

        /* Game Scene */
        .game-scene {
            position: relative;
            height: 160px;
            background: linear-gradient(180deg, transparent 0%, transparent 70%, var(--grass-green) 70%, var(--ground-brown) 85%);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 8px;
            border: 3px solid #000;
        }

        /* Clouds */
        .cloud {
            position: absolute;
            background: rgba(255,255,255,0.9);
            border-radius: 20px;
        }
        .cloud-1 { width: 60px; height: 25px; top: 15px; left: 10%; animation: float-cloud 20s linear infinite; }
        .cloud-2 { width: 45px; height: 20px; top: 30px; right: 15%; animation: float-cloud 25s linear infinite reverse; }

        @keyframes float-cloud {
            0% { transform: translateX(-100px); }
            100% { transform: translateX(400px); }
        }

        /* Princess */
        .princess {
            position: absolute;
            bottom: 45px;
            width: 48px;
            height: 72px;
            z-index: 10;
        }

        .princess.idle {
            animation: bella-run 2.5s linear infinite;
        }

        @keyframes bella-run {
            0% { left: 15%; transform: scaleX(1); }
            48% { left: 75%; transform: scaleX(1); }
            50% { left: 75%; transform: scaleX(-1); }
            98% { left: 15%; transform: scaleX(-1); }
            100% { left: 15%; transform: scaleX(1); }
        }

        .princess.working {
            animation: bella-stomp 1.2s ease-in-out infinite;
        }

        @keyframes bella-stomp {
            0% { left: 65%; transform: scaleX(-1); }
            20% { left: 50%; transform: scaleX(-1) translateY(-8px); }
            25% { left: 45%; transform: scaleX(-1) translateY(0); }
            50% { left: 30%; transform: scaleX(-1) translateY(-8px); }
            55% { left: 25%; transform: scaleX(-1) translateY(0); }
            80% { left: 15%; transform: scaleX(-1); }
            100% { left: 65%; transform: scaleX(-1); }
        }

        .princess.thinking, .princess.error {
            left: 50%;
            transform: translateX(-50%);
            animation: bella-idle 1s ease-in-out infinite;
        }

        @keyframes bella-idle {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-4px); }
        }

        /* Crab */
        .crab {
            position: absolute;
            bottom: 48px;
            width: 32px;
            height: 24px;
            z-index: 5;
        }

        .crab.chasing {
            animation: crab-chase 2.5s linear infinite;
        }

        @keyframes crab-chase {
            0% { left: 5%; transform: scaleX(1); }
            48% { left: 65%; transform: scaleX(1); }
            50% { left: 65%; transform: scaleX(-1); }
            98% { left: 5%; transform: scaleX(-1); }
            100% { left: 5%; transform: scaleX(1); }
        }

        .crab.fleeing {
            animation: crab-flee 1.2s ease-in-out infinite;
        }

        @keyframes crab-flee {
            0% { left: 55%; opacity: 1; transform: scaleX(-1); }
            40% { left: 25%; opacity: 1; transform: scaleX(-1); }
            60% { left: 10%; opacity: 0.3; transform: scaleX(-1) rotate(180deg); }
            80% { left: 5%; opacity: 0; transform: scaleX(-1) rotate(360deg); }
            100% { left: 55%; opacity: 1; transform: scaleX(-1); }
        }

        .crab.hiding {
            left: 5%;
            opacity: 0.4;
        }

        /* Stomp effects */
        .stomp { position: absolute; bottom: 50px; font-size: 20px; opacity: 0; z-index: 20; }
        .stomp.show { animation: stomp-pop 0.4s ease-out forwards; }
        @keyframes stomp-pop {
            0% { opacity: 1; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1.3) translateY(-15px); }
            100% { opacity: 0; transform: scale(1) translateY(-25px); }
        }

        /* Speech bubble */
        .speech {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 2px solid #000;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 7px;
            max-width: 180px;
            text-align: center;
            z-index: 30;
        }

        .speech::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #000;
        }

        /* Status Bar */
        .status-bar {
            background: var(--dark-bg);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--pipe-green);
            animation: pulse 1s ease-in-out infinite;
        }

        .status-indicator.working { background: var(--coin-yellow); }
        .status-indicator.error { background: var(--accent); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-text {
            font-size: 8px;
            color: var(--text-white);
            flex: 1;
        }

        .status-time {
            font-size: 7px;
            color: #888;
        }

        /* Current Task Card */
        .task-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid var(--coin-yellow);
        }

        .task-label {
            font-size: 7px;
            color: #888;
            margin-bottom: 6px;
        }

        .task-text {
            font-size: 9px;
            color: var(--text-white);
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .progress-bar {
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--pipe-green), var(--coin-yellow));
            transition: width 0.3s ease;
        }

        /* Health Grid */
        .health-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 8px;
        }

        .health-item {
            background: var(--card-bg);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
        }

        .health-icon { font-size: 16px; margin-bottom: 4px; }
        .health-label { font-size: 6px; color: #888; margin-bottom: 2px; }
        .health-value { font-size: 8px; color: var(--pipe-green); }
        .health-value.warning { color: var(--coin-yellow); }
        .health-value.error { color: var(--accent); }

        /* Activity Feed */
        .activity-feed {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 10px;
        }

        .activity-header {
            font-size: 8px;
            color: var(--coin-yellow);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activity-list {
            max-height: 150px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px solid #333;
            font-size: 7px;
            color: var(--text-white);
        }

        .activity-item:last-child { border-bottom: none; }
        .activity-icon { font-size: 12px; }
        .activity-content { flex: 1; line-height: 1.4; }
        .activity-time { color: #666; font-size: 6px; }

        /* Message Fab */
        .message-fab {
            position: fixed;
            bottom: 16px;
            right: 16px;
            width: 48px;
            height: 48px;
            background: var(--coin-yellow);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            border: 3px solid #000;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .message-fab.has-new {
            background: var(--pipe-green);
            animation: bounce 0.5s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .message-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--accent);
            color: white;
            font-size: 8px;
            padding: 2px 6px;
            border-radius: 10px;
            display: none;
        }

        .message-badge.show { display: block; }

        /* Message Panel */
        .message-panel {
            position: fixed;
            bottom: 70px;
            right: 16px;
            width: 280px;
            max-height: 300px;
            background: var(--dark-bg);
            border-radius: 12px;
            border: 2px solid var(--coin-yellow);
            display: none;
            z-index: 99;
            overflow: hidden;
        }

        .message-panel.show { display: block; }

        .message-panel-header {
            background: var(--coin-yellow);
            color: #000;
            padding: 8px 12px;
            font-size: 8px;
            display: flex;
            justify-content: space-between;
        }

        .message-panel-content {
            padding: 8px;
            max-height: 250px;
            overflow-y: auto;
        }

        .message-bubble {
            background: #2a2a4a;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 6px;
            font-size: 8px;
            color: var(--text-white);
        }

        .message-sender { color: var(--coin-yellow); font-size: 7px; margin-bottom: 4px; }
        .message-time { color: #666; font-size: 6px; margin-top: 4px; }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 8px;
        }
    </style>
</head>
<body>
    <!-- Message FAB -->
    <div class="message-fab" id="messageFab" onclick="toggleMessages()">
        üí¨
        <span class="message-badge" id="messageBadge">0</span>
    </div>

    <!-- Message Panel -->
    <div class="message-panel" id="messagePanel">
        <div class="message-panel-header">
            <span>üì® MESSAGES</span>
            <span onclick="toggleMessages()" style="cursor:pointer">‚úï</span>
        </div>
        <div class="message-panel-content" id="messageList">
            <div class="empty-state">No messages yet</div>
        </div>
    </div>

    <div class="game-container">
        <!-- Header -->
        <div class="header">
            <div class="header-title">ü¶Ä BELLA</div>
            <div class="header-stats">
                <div class="stat-item">
                    <div>TASKS</div>
                    <div class="stat-value" id="taskCount">0</div>
                </div>
                <div class="stat-item">
                    <div>TIME</div>
                    <div class="stat-value" id="timeDisplay">00:00</div>
                </div>
            </div>
        </div>

        <!-- Game Scene -->
        <div class="game-scene">
            <div class="cloud cloud-1"></div>
            <div class="cloud cloud-2"></div>

            <div class="speech" id="speech">Ready for adventure!</div>

            <div class="princess idle" id="princess">
                <svg viewBox="0 0 16 24" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:100%">
                    <rect x="5" y="0" width="6" height="2" fill="#ffd700"/>
                    <rect x="4" y="1" width="1" height="2" fill="#ffd700"/>
                    <rect x="11" y="1" width="1" height="2" fill="#ffd700"/>
                    <rect x="7" y="0" width="2" height="1" fill="#ff0000"/>
                    <rect x="3" y="2" width="10" height="3" fill="#fca044"/>
                    <rect x="2" y="3" width="1" height="4" fill="#fca044"/>
                    <rect x="13" y="3" width="1" height="4" fill="#fca044"/>
                    <rect x="5" y="5" width="6" height="5" fill="#fcdcac"/>
                    <rect x="6" y="6" width="1" height="2" fill="#000"/>
                    <rect x="9" y="6" width="1" height="2" fill="#000"/>
                    <rect x="7" y="9" width="2" height="1" fill="#f890a8"/>
                    <rect x="4" y="10" width="8" height="2" fill="#f890a8"/>
                    <rect x="3" y="12" width="10" height="6" fill="#f890a8"/>
                    <rect x="2" y="14" width="12" height="4" fill="#f890a8"/>
                    <rect x="2" y="11" width="2" height="4" fill="#fcdcac"/>
                    <rect x="12" y="11" width="2" height="4" fill="#fcdcac"/>
                    <rect x="1" y="18" width="14" height="4" fill="#f890a8"/>
                    <rect x="3" y="22" width="3" height="2" fill="#f00"/>
                    <rect x="10" y="22" width="3" height="2" fill="#f00"/>
                </svg>
            </div>

            <div class="crab chasing" id="crab">
                <svg viewBox="0 0 16 12" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:100%">
                    <rect x="4" y="4" width="8" height="6" fill="#ff6b35"/>
                    <rect x="3" y="5" width="10" height="4" fill="#ff6b35"/>
                    <rect x="5" y="2" width="2" height="3" fill="#ff6b35"/>
                    <rect x="9" y="2" width="2" height="3" fill="#ff6b35"/>
                    <rect x="5" y="2" width="2" height="2" fill="#fff"/>
                    <rect x="9" y="2" width="2" height="2" fill="#fff"/>
                    <rect x="6" y="2" width="1" height="1" fill="#000"/>
                    <rect x="10" y="2" width="1" height="1" fill="#000"/>
                    <rect x="0" y="5" width="3" height="3" fill="#ff6b35"/>
                    <rect x="13" y="5" width="3" height="3" fill="#ff6b35"/>
                    <rect x="4" y="10" width="2" height="2" fill="#ff6b35"/>
                    <rect x="10" y="10" width="2" height="2" fill="#ff6b35"/>
                </svg>
            </div>

            <div class="stomp" id="stomp1" style="left:35%">üí•</div>
            <div class="stomp" id="stomp2" style="left:25%">‚≠ê</div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-indicator" id="statusIndicator"></div>
            <div class="status-text" id="statusText">CRAB CHASE!</div>
            <div class="status-time" id="lastUpdate">--:--</div>
        </div>

        <!-- Current Task -->
        <div class="task-card">
            <div class="task-label">CURRENT QUEST</div>
            <div class="task-text" id="taskText">Waiting for a new adventure...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width:0%"></div>
            </div>
        </div>

        <!-- Health Grid -->
        <div class="health-grid">
            <div class="health-item">
                <div class="health-icon">üè∞</div>
                <div class="health-label">GATEWAY</div>
                <div class="health-value" id="gatewayStatus">--</div>
            </div>
            <div class="health-item">
                <div class="health-icon">üì±</div>
                <div class="health-label">TELEGRAM</div>
                <div class="health-value" id="telegramStatus">--</div>
            </div>
            <div class="health-item">
                <div class="health-icon">üîë</div>
                <div class="health-label">APIS</div>
                <div class="health-value" id="apiStatus">--</div>
            </div>
        </div>

        <!-- Activity Feed -->
        <div class="activity-feed">
            <div class="activity-header">
                <span>üìú ACTIVITY LOG</span>
                <span id="activityCount">0 events</span>
            </div>
            <div class="activity-list" id="activityList">
                <div class="empty-state">No activity yet. Send a message to get started!</div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram?.WebApp;
        if (tg) { tg.ready(); tg.expand(); }

        // Elements
        const princess = document.getElementById('princess');
        const crab = document.getElementById('crab');
        const speech = document.getElementById('speech');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const taskText = document.getElementById('taskText');
        const progressFill = document.getElementById('progressFill');
        const activityList = document.getElementById('activityList');
        const activityCount = document.getElementById('activityCount');
        const taskCount = document.getElementById('taskCount');
        const timeDisplay = document.getElementById('timeDisplay');
        const lastUpdate = document.getElementById('lastUpdate');
        const messageFab = document.getElementById('messageFab');
        const messageBadge = document.getElementById('messageBadge');
        const messagePanel = document.getElementById('messagePanel');
        const messageList = document.getElementById('messageList');
        const stomp1 = document.getElementById('stomp1');
        const stomp2 = document.getElementById('stomp2');

        let panelOpen = false;
        let unreadCount = 0;
        let lastMessageId = 0;
        let stompInterval = null;

        const speeches = {
            idle: ["Help! Crab chasing me!", "Run away!", "Send a message!", "The crab!"],
            working: ["Take THAT crab!", "Stomp stomp!", "Working hard!", "Got you!"],
            thinking: ["Hmm...", "Let me think...", "Processing..."],
            error: ["Oh no!", "Error!", "Help!"]
        };

        function toggleMessages() {
            panelOpen = !panelOpen;
            messagePanel.classList.toggle('show', panelOpen);
            if (panelOpen) {
                unreadCount = 0;
                messageBadge.textContent = '0';
                messageBadge.classList.remove('show');
                messageFab.classList.remove('has-new');
            }
        }

        function updateTime() {
            const now = new Date();
            timeDisplay.textContent = now.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });
        }
        setInterval(updateTime, 1000);
        updateTime();

        function triggerStomp() {
            stomp1.classList.add('show');
            setTimeout(() => { stomp1.classList.remove('show'); stomp2.classList.add('show'); }, 300);
            setTimeout(() => stomp2.classList.remove('show'), 600);
        }

        function updateStatus(data) {
            const status = data.status || 'idle';

            // Update princess and crab
            princess.className = 'princess ' + status;
            crab.className = 'crab ' + (status === 'working' ? 'fleeing' : status === 'idle' ? 'chasing' : 'hiding');

            // Status indicator
            statusIndicator.className = 'status-indicator ' + status;

            // Clear/set stomp interval
            if (stompInterval) { clearInterval(stompInterval); stompInterval = null; }
            if (status === 'working') {
                stompInterval = setInterval(triggerStomp, 1200);
                triggerStomp();
            }

            // Status text
            const statusLabels = {
                idle: 'CRAB CHASE!',
                working: 'STOMPING CRABS!',
                thinking: 'THINKING...',
                error: 'ERROR!'
            };
            statusText.textContent = statusLabels[status] || 'IDLE';

            // Speech
            const msgs = speeches[status] || speeches.idle;
            speech.textContent = msgs[Math.floor(Math.random() * msgs.length)];

            // Task
            taskText.textContent = data.currentTask || 'Waiting for adventure...';
            progressFill.style.width = (data.progress || 0) + '%';
            taskCount.textContent = data.taskCount || 0;

            // Health
            document.getElementById('gatewayStatus').textContent = data.health?.gateway || '--';
            document.getElementById('telegramStatus').textContent = data.health?.telegram || '--';
            document.getElementById('apiStatus').textContent = data.health?.apis || '--';

            // Last update time
            lastUpdate.textContent = new Date().toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });

            // Activities
            const activities = data.activities || [];
            activityCount.textContent = activities.length + ' events';

            if (activities.length === 0) {
                activityList.innerHTML = '<div class="empty-state">No activity yet. Send a message!</div>';
            } else {
                activityList.innerHTML = activities.map(a => `
                    <div class="activity-item">
                        <span class="activity-icon">${a.icon || 'üìå'}</span>
                        <span class="activity-content">${a.text}</span>
                        <span class="activity-time">${a.time}</span>
                    </div>
                `).join('');
            }
        }

        function updateMessages(data) {
            const messages = data.messages || [];

            if (messages.length === 0) {
                messageList.innerHTML = '<div class="empty-state">No messages yet</div>';
                return;
            }

            // Check for new messages
            const newMsgs = messages.filter(m => m.id > lastMessageId);
            if (newMsgs.length > 0 && !panelOpen) {
                unreadCount += newMsgs.length;
                messageBadge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                messageBadge.classList.add('show');
                messageFab.classList.add('has-new');
            }
            if (messages.length > 0) {
                lastMessageId = Math.max(...messages.map(m => m.id || 0));
            }

            messageList.innerHTML = messages.slice(0, 8).map(m => `
                <div class="message-bubble">
                    <div class="message-sender">${m.sender || 'User'}</div>
                    <div>${m.text}</div>
                    <div class="message-time">${m.time}</div>
                </div>
            `).join('');
        }

        async function fetchStatus() {
            try {
                const res = await fetch('./status.json?t=' + Date.now());
                if (res.ok) updateStatus(await res.json());
            } catch (e) { console.error('Status error:', e); }
        }

        async function fetchMessages() {
            try {
                const res = await fetch('./messages.json?t=' + Date.now());
                if (res.ok) updateMessages(await res.json());
            } catch (e) { /* silent */ }
        }

        // Initial load & intervals
        fetchStatus();
        fetchMessages();
        setInterval(fetchStatus, 3000);
        setInterval(fetchMessages, 2000);
    </script>
</body>
</html>
